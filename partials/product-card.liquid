{% assign show_vendor = show_vendor | default: false %}
{% assign show_quick_add = show_quick_add | default: true %}
{% assign image_ratio = image_ratio | default: 'aspect-square' %}

<article
  class="group relative"
  x-data="productCard({ variantId: {{ product.variants.first.id }} })"
  data-product-id="{{ product.id }}"
>
  <a href="{{ product.url }}" class="block overflow-hidden rounded-lg bg-muted {{ image_ratio }}">
    {% if product.featured_image %}
      <img
        src="{{ product.featured_image | img_url: '600x600' }}"
        alt="{{ product.featured_image.alt | escape | default: product.title }}"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
        loading="lazy"
      >
      {% if product.images[1] %}
        <img
          src="{{ product.images[1] | img_url: '600x600' }}"
          alt="{{ product.images[1].alt | escape | default: product.title }}"
          class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-300 group-hover:opacity-100"
          loading="lazy"
        >
      {% endif %}
    {% else %}
      <div class="w-full h-full flex items-center justify-center">
        <i class="ri-image-line text-4xl text-muted-foreground"></i>
      </div>
    {% endif %}
  </a>

  {% if product.compare_at_price > product.price %}
    {% assign savings = product.compare_at_price | minus: product.price %}
    {% assign savings_percent = savings | times: 100 | divided_by: product.compare_at_price %}
    <span class="absolute top-2 left-2 bg-destructive text-destructive-foreground text-xs font-medium px-2 py-1 rounded-md">
      -{{ savings_percent }}%
    </span>
  {% endif %}

  {% unless product.available %}
    <span class="absolute top-2 right-2 bg-muted text-muted-foreground text-xs font-medium px-2 py-1 rounded-md">
      Sold Out
    </span>
  {% endunless %}

  {% if show_quick_add and product.available %}
    <button
      class="absolute bottom-2 right-2 bg-primary text-primary-foreground p-2 rounded-lg opacity-0 translate-y-2 transition-all duration-200 group-hover:opacity-100 group-hover:translate-y-0 hover:bg-primary/90 disabled:opacity-50"
      @click.prevent="addToCart"
      :disabled="loading"
      aria-label="Add {{ product.title }} to cart"
    >
      <i class="ri-loader-4-line text-lg animate-spin" x-show="loading"></i>
      <i class="ri-check-line text-lg" x-show="added && !loading"></i>
      <i class="ri-add-line text-lg" x-show="!loading && !added"></i>
    </button>
  {% endif %}

  <div class="mt-3 space-y-1">
    {% if show_vendor and product.vendor %}
      <p class="text-xs text-muted-foreground uppercase tracking-wide">{{ product.vendor }}</p>
    {% endif %}

    <h3 class="text-sm font-medium">
      <a href="{{ product.url }}" class="hover:underline">
        {{ product.title }}
      </a>
    </h3>

    <div class="flex items-center gap-2">
      <span class="text-sm font-semibold">
        {{ product.price | money }}
      </span>
      {% if product.compare_at_price > product.price %}
        <span class="text-sm text-muted-foreground line-through">
          {{ product.compare_at_price | money }}
        </span>
      {% endif %}
    </div>

    {% assign color_options = product.options_by_name['Color'].values %}
    {% if color_options.size > 1 %}
      <div class="flex gap-1 pt-1">
        {% for color in color_options limit: 5 %}
          <span
            class="w-4 h-4 rounded-full border border-border"
            style="background-color: {{ color | handleize }};"
            title="{{ color }}"
          ></span>
        {% endfor %}
        {% if color_options.size > 5 %}
          <span class="text-xs text-muted-foreground">+{{ color_options.size | minus: 5 }}</span>
        {% endif %}
      </div>
    {% endif %}
  </div>
</article>
